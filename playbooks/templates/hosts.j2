[OSEv3:children]
masters
etcd
nodes
{% if groups['lb'] is defined %}
lb
{% endif %}
{% if deploy_ocs | default('true') | bool %}
glusterfs
glusterfs_registry
{% endif %}

[OSEv3:vars]
### REGISTRY ###
# fix for bug
# https://access.redhat.com/solutions/3480921
#ereg_url_master=registry.access.redhat.com/openshift3/ose-${component}:${version}
#oreg_url_node=registry.access.redhat.com/openshift3/ose-${component}:${version}
openshift_hosted_registry_replicas={{ infra_nodes }}
oreg_auth_user={{ oreg_auth_user | default('') }}
oreg_auth_password={{ oreg_auth_password | default('') }}

### MASTER/CLUSTER ###
openshift_examples_modify_imagestreams=true
{% if storage_type == 'dynamic' %}
openshift_master_dynamic_provisioning_enabled=True
{% endif %}
ansible_ssh_user="{{ admin_user }}"
ansible_become=true
openshift_deployment_type=openshift-enterprise
openshift_release='3.11'
ansible_become=true
openshift_master_api_port=443
openshift_master_console_port=443
openshift_master_cluster_method=native
openshift_master_cluster_hostname={{ load_balancer_hostname }}
openshift_master_cluster_public_hostname={{ openshift_master_cluster_public_hostname }}
openshift_master_default_subdomain={{ wildcard_zone |default('apps.change.me') }}
{% if osm_cluster_network_cidr is defined %}
osm_cluster_network_cidr={{ osm_cluster_network_cidr }}
{% endif %}
{% if openshift_portal_net is defined %}
openshift_portal_net={{ openshift_portal_net }}
{% endif %}
os_sdn_network_plugin_name={{ os_sdn_network_plugin_name | default('redhat/openshift-ovs-multitenant') }}
{% if openshift_disable_check is defined %}
openshift_disable_check={{ openshift_disable_check }}
{% endif %}
{% if master_cert is defined %}
# MASTER/API
#openshift_master_overwrite_named_certificates=true
openshift_master_named_certificates={{ master_cert }}
{% endif %}
{% if openshift_master_identity_providers is defined %}
openshift_master_identity_providers={{ openshift_master_identity_providers }}
{% else %}
openshift_master_identity_providers=[{'name': 'htpasswd_auth', 'login': 'true', 'challenge': 'true', 'kind': 'HTPasswdPasswordIdentityProvider'}]
{% endif %}
{% if openshift_master_htpasswd_users is defined %}
openshift_master_htpasswd_users={{ openshift_master_htpasswd_users }}
{% else %}
# admin:changeme
openshift_master_htpasswd_users={'admin': '$apr1$VZeARzoK$zYM/4c82PKDeYmw6/RvOV/'}
{% endif %}
openshift_master_manage_htpasswd=true
{% if osm_project_request_message is defined %}
osm_project_request_message="{{ osm_project_request_message }}"
{% endif %}
os_firewall_use_firewalld=True


### INFRA ###
# Routers
openshift_node_open_ports=[{"service":"router_health","port":"1936/tcp"}]
{% if router_cert is defined %}
openshift_hosted_router_certificate={{ router_cert }}
{% endif %}
openshift_hosted_router_replicas={{ infra_nodes }}

# Operator Lifecycle Manager ( Tech Preview )
{% if deploy_olm | default('True') | bool %}
openshift_enable_olm=true
openshift_additional_registry_credentials=[{'host':'registry.connect.redhat.com','user':'{{ oreg_auth_user }}','password':'{{ oreg_auth_password }}','test_image':'mongodb/enterprise-operator:0.3.2'}]
{% endif %}

{% if deploy_logging | default('True') | bool %}
# Logging
openshift_logging_install_logging=True
openshift_logging_es_memory_limit={{ logging_es_mem }}
{% if storage_type == 'dynamic' %}
openshift_logging_es_pvc_dynamic=True
openshift_logging_es_pvc_size={{ logging_volume_size }}
{% endif %}
openshift_logging_es_cluster_size={{ infra_nodes }}
{% if deploy_ocs | default('true') | bool %}
openshift_logging_es_pvc_storage_class_name='glusterfs-registry-block'
{% endif %}
openshift_logging_kibana_nodeselector={"node-role.kubernetes.io/infra": "true"}
openshift_logging_curator_nodeselector={"node-role.kubernetes.io/infra": "true"}
openshift_logging_es_nodeselector={"node-role.kubernetes.io/infra": "true"}
{% else %}
openshift_logging_install_logging=False
{% endif %}

# Metrics
{% if deploy_logging | default('True') | bool %}
openshift_metrics_install_metrics=True
{% if storage_type == 'dynamic' %}
openshift_metrics_storage_kind=dynamic
openshift_metrics_storage_volume_size={{ metrics_volume_size }}
{% endif %}
{% if deploy_ocs | default('true') | bool %}
openshift_metrics_cassandra_pvc_storage_class_name='glusterfs-registry-block'
{% endif %}
openshift_metrics_hawkular_nodeselector={"node-role.kubernetes.io/infra": "true"}
openshift_metrics_cassandra_nodeselector={"node-role.kubernetes.io/infra": "true"}
openshift_metrics_heapster_nodeselector={"node-role.kubernetes.io/infra": "true"}
{% else %}
openshift_metrics_install_metrics=False
{% endif %}

# Prometheus
{% if deploy_prometheus | default(True) | bool %}
openshift_cluster_monitoring_operator_install=True 
{% if storage_type == 'dynamic' %}
openshift_cluster_monitoring_operator_prometheus_storage_capacity={{ prometheus_volume_size | default('50Gi') }}
openshift_cluster_monitoring_operator_prometheus_storage_enabled=True
openshift_cluster_monitoring_operator_alertmanager_enabled=True
openshift_cluster_monitoring_operator_prometheus_enabled=True
{% endif %}
{% if deploy_ocs | default('true') | bool %}
openshift_cluster_monitoring_operator_prometheus_storage_class_name='glusterfs-registry-block'
{% endif %}
{% else %}
openshift_cluster_monitoring_operator_install=True 
{% endif %}

# Grafana
#{% if deploy_grafana | default(true) | bool %}
#openshift_grafana_state=present
#openshift_grafana_node_exporter=True
#openshift_grafana_storage_type=pvc
#openshift_grafana_storage_class='glusterfs-registry-block'
#openshift_grafana_prometheus_namespace='openshift-metrics'
#openshift_grafana_prometheus_serviceaccount='prometheus'
#openshift_grafana_prometheus_route='prometheus'
#{% else %}
#openshift_grafana_state=absent
#{% endif %}

### NODES ###
openshift_node_local_quota_per_fsgroup=512Mi
container_runtime_docker_storage_setup_device=/dev/vdb
container_runtime_docker_storage_type=overlay2
osm_use_cockpit=false

### OCS ###
{% if deploy_ocs | default(true) | bool %}
# CNS Cnfiguration
# Container image to use for glusterfs pods
openshift_storage_glusterfs_image="registry.access.redhat.com/rhgs3/rhgs-server-rhel7:v3.10"
# Container image to use for glusterblock-provisioner pod
openshift_storage_glusterfs_block_image="registry.access.redhat.com/rhgs3/rhgs-gluster-block-prov-rhel7:v3.10"
# Container image to use for heketi pods
openshift_storage_glusterfs_heketi_image="registry.access.redhat.com/rhgs3/rhgs-volmanager-rhel7:v3.10"
# Container image to user for S3
openshift_storage_glusterfs_s3_image=registry.access.redhat.com/rhgs3/rhgs-gluster-s3-server-rhel7:v3.10"
# Cluster 1
# Total Storage allocated (GB) = {{ ocs_infra_cluster_allocated_storage }}
# Total Storage available (GB) = {{ ocs_infra_cluster_usable_storage }}
{% if infra_nodes + app_nodes >= 6 %}
# Cluster 2
# Total Storage allocated (GB) = 0
# Total Storage available (GB) = {{ ocs_app_cluster_usable_storage }}

# CNS storage cluster
openshift_storage_glusterfs_namespace=app-storage
openshift_storage_glusterfs_storageclass=true
openshift_storage_glusterfs_storageclass_default=True
openshift_storage_glusterfs_block_deploy=True
openshift_storage_glusterfs_block_host_vol_create=false
openshift_storage_glusterfs_block_host_vol_size=100
openshift_storage_glusterfs_block_storageclass=false
openshift_storage_glusterfs_block_storageclass_default=false
{% endif %}
# CNS storage for OpenShift infrastructure
openshift_storage_glusterfs_registry_namespace=infra-storage
openshift_storage_glusterfs_registry_storageclass=false
openshift_storage_glusterfs_registry_block_deploy=true
openshift_storage_glusterfs_registry_block_host_vol_create=true
openshift_storage_glusterfs_registry_block_host_vol_size={{ ocs_infra_cluster_allocated_storage }}
openshift_storage_glusterfs_registry_block_storageclass=true
openshift_storage_glusterfs_registry_block_storageclass_default=false

{% else %}
# StorageClass if not OCS
openshift_storageclass_default=true
{% endif %}

[masters]
{% for i in range(1, master_nodes +1) %}
master0{{ i }}.{{ local_hosted_zone }}
{% endfor %}

[infra]
{% for i in range(1, infra_nodes +1) %}
infra0{{ i }}.{{ local_hosted_zone }}
{% endfor %}

{% if groups['lb'] is defined %}
[lb]
ocp-lb-1
{% endif %}

[etcd]

[etcd:children]
masters

[nodes]
{% for i in range(1, master_nodes +1) %}
master0{{ i }}.{{ local_hosted_zone }} openshift_node_group_name='node-config-master' openshift_schedulable=true
{% endfor %}
{% for i in range(1, infra_nodes +1) %}
infra0{{ i }}.{{ local_hosted_zone }}  openshift_node_group_name='node-config-infra'
{% endfor %}
{% for i in range(1, app_nodes +1) %}
app0{{ i }}.{{ local_hosted_zone }}    openshift_node_group_name='node-config-compute'
{% endfor %}

{% if deploy_ocs | default(true) | bool  and deploy_ocs is defined %}
{% if ( infra_nodes + app_nodes ) >= 6 %}
[glusterfs_registry]
{% for i in range(1, infra_nodes+1) %}
infra0{{ i }}.{{ local_hosted_zone }} glusterfs_zone={{ i }}  glusterfs_devices='[ "/dev/vdd" ]'
{% endfor %}

[glusterfs]
{% for i in range(1, infra_nodes +1) %}
app0{{ i }}.{{ local_hosted_zone }} glusterfs_zone={{ i }} glusterfs_devices='[ "/dev/vdd" ]'
{% endfor %}
{% else %}
[glusterfs_registry]
[glusterfs]
{% for i in range(1, infra_nodes +1) %}
infra0{{ i }}.{{ local_hosted_zone }}  glusterfs_zone={{ i }} glusterfs_devices='[ "/dev/vdd" ]'
{% endfor %}
{% endif %}
{% endif %}
